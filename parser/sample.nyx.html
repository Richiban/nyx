<html>
  <head>
    <style>
      body {
        font-family: monospace;
        background-color: #2c2c2c;
        color: #e4e4e4;
      }
      .keyword {
        color: #8e8eee;
      }
      .control {
        color: #c07cd1;
      }
      .identifier {
      }
      .function {
        color: #c9b181;
      }
      .string {
        color: #a36a15;
      }
      .number {
        color: #098658;
      }
      .context, .tag, .type {
        color: #17aa8a;
      }
      .comment {
        color: #008000;
      }
    </style>
  </head>
  <body>
    <pre><code>
<span class="keyword">module</span> <span class="identifier">StopwatchApp</span>

<span class="comment">-- Context: Logger</span>
<span class="keyword">context</span> <span class="context">Logger</span> = {
  <span class="keyword">def</span> <span class="function">log</span> { <span class="identifier">msg</span> ->
    <span class="identifier">print</span>(<span class="string">"[log] {msg}"</span>)
  }
}

<span class="comment">-- Context: Stopwatch</span>
<span class="keyword">context</span> <span class="context">Stopwatch</span> = {
  <span class="keyword">def</span> <span class="function">startTime</span> = <span class="keyword">mut</span> <span class="identifier">none</span>()
  <span class="keyword">def</span> <span class="function">elapsed</span> : <span class="keyword">mut</span> <span class="type">float&lt;s&gt;</span> = <span class="number">0.0s</span>

  <span class="keyword">def</span> <span class="function">start</span> [<span class="context">Logger</span>] {
    <span class="control">match</span> <span class="identifier">startTime</span>
    | <span class="tag">#none</span> ->
      <span class="keyword">def</span> <span class="identifier">now</span> = <span class="identifier">systemTime</span>()
      <span class="keyword">set</span> <span class="identifier">startTime</span> = <span class="identifier">some</span>(<span class="identifier">now</span>)
      <span class="function">log</span>(<span class="string">"Stopwatch started at {now}"</span>)
      <span class="tag">#ok</span>
    | <span class="tag">#some</span> _ ->
      <span class="function">log</span>(<span class="string">"Stopwatch is already running."</span>)
      <span class="tag">#error</span> <span class="string">"already running"</span>
  }

  <span class="keyword">def</span> <span class="function">stop</span> [<span class="context">Logger</span>] {
    <span class="control">match</span> <span class="identifier">startTime</span>
    | <span class="tag">#some</span> <span class="identifier">started</span> ->
      <span class="keyword">def</span> <span class="identifier">now</span> = <span class="identifier">systemTime</span>()
      <span class="keyword">def</span> <span class="identifier">delta</span> = <span class="identifier">now</span> - <span class="identifier">started</span>
      <span class="keyword">set</span> <span class="identifier">elapsed</span> = <span class="identifier">elapsed</span> + <span class="identifier">delta</span>
      <span class="keyword">set</span> <span class="identifier">startTime</span> = <span class="identifier">none</span>()
      <span class="function">log</span>(<span class="string">"Stopwatch stopped. Added {delta} seconds."</span>)
      <span class="tag">#ok</span>
    | <span class="tag">#none</span> ->
      <span class="function">log</span>(<span class="string">"Stopwatch is not running."</span>)
      <span class="tag">#error</span> <span class="string">"not running"</span>
  }

  <span class="keyword">def</span> <span class="function">reset</span> [<span class="context">Logger</span>] {
    <span class="keyword">set</span> <span class="identifier">elapsed</span> = <span class="number">0.0s</span>
    <span class="keyword">set</span> <span class="identifier">startTime</span> = <span class="identifier">none</span>()
    <span class="function">log</span>(<span class="string">"Stopwatch reset."</span>)
    <span class="tag">#ok</span>
  }

  <span class="keyword">def</span> <span class="function">read</span> [<span class="context">Logger</span>] {
    <span class="control">match</span> <span class="identifier">startTime</span>
    | <span class="tag">#some</span> <span class="identifier">started</span> ->
      <span class="keyword">def</span> <span class="identifier">now</span> = <span class="identifier">systemTime</span>()
      <span class="keyword">def</span> <span class="identifier">total</span> = <span class="identifier">elapsed</span> + (<span class="identifier">now</span> - <span class="identifier">started</span>)
      <span class="function">log</span>(<span class="string">"Current elapsed: </span>{total}<span class="string">"</span>)
      <span class="identifier">total</span>
    | <span class="tag">#none</span> ->
      <span class="function">log</span>(<span class="string">"Current elapsed: </span>{elapsed}<span class="string">"</span>)
      <span class="identifier">elapsed</span>
  }
}

<span class="comment">-- Main loop</span>
<span class="keyword">def</span> <span class="function">loop</span> [<span class="context">Console</span>, <span class="context">Async</span>, <span class="context">Logger</span>, <span class="context">Stopwatch</span>] {
  <span class="identifier">print</span>(<span class="string">"Command: start | stop | reset | read | exit"</span>)
  <span class="keyword">def</span> <span class="identifier">input</span> = <span class="control">await</span> <span class="identifier">readLine</span>()

  <span class="control">match</span> <span class="identifier">input</span>
  | <span class="string">"start"</span> -> <span class="context">Stopwatch</span>.<span class="function">start</span>()
  | <span class="string">"stop"</span> -> <span class="context">Stopwatch</span>.<span class="function">stop</span>()
  | <span class="string">"reset"</span> -> <span class="context">Stopwatch</span>.<span class="function">reset</span>()
  | <span class="string">"read"</span> ->
    <span class="keyword">def</span> <span class="identifier">e</span> = <span class="context">Stopwatch</span>.<span class="function">read</span>()
    <span class="identifier">print</span>(<span class="string">"Elapsed: {e} seconds"</span>)
  | <span class="string">"exit"</span> -> <span class="tag">#exit</span>
  | _ -> <span class="identifier">print</span>(<span class="string">"Unknown command."</span>)

  <span class="function">loop</span>()
}

<span class="function">loop</span>()
    </code></pre>
  </body>
</html>
